<!-- public/login.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SonaTips | Login/Register</title>
<link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="auth-container">
    <h1 id="auth-title">Login</h1>
    <div id="message"></div>
    <form id="auth-form">
      <input type="email" id="email" placeholder="Email" required>
      <input type="password" id="password" placeholder="Password" required>
      <button type="submit" id="auth-button">Login</button>
    </form>
    <div class="toggle-link" id="toggle-auth">Don't have an account? Register</div>
  </div>

  <script type="module">
  import { loginUser, registerUser, addUserToFirestore, getUserData } from './js/firebase.js';

  const authForm = document.getElementById('auth-form');
  const toggleAuth = document.getElementById('toggle-auth');
  const authTitle = document.getElementById('auth-title');
  const authButton = document.getElementById('auth-button');
  const messageDiv = document.getElementById('message');

  let isLogin = true;

  // Toggle Login/Register
  toggleAuth.addEventListener('click', () => {
    isLogin = !isLogin;
    if(isLogin){
      authTitle.textContent = 'Login';
      authButton.textContent = 'Login';
      toggleAuth.textContent = "Don't have an account? Register";
    } else {
      authTitle.textContent = 'Register';
      authButton.textContent = 'Register';
      toggleAuth.textContent = "Already have an account? Login";
    }
    messageDiv.innerHTML = '';
  });

  authForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    messageDiv.innerHTML = `<div class="loading-spinner"></div>`;

    try {
      let userCredential;
      if(isLogin){
        userCredential = await loginUser(email, password);
      } else {
        userCredential = await registerUser(email, password);
        // Add new user to Firestore with default free subscription
        await addUserToFirestore({
          email: userCredential.user.email,
          uid: userCredential.user.uid,
          createdAt: new Date().toISOString(),
          subscription: "free",
          billing: null,
          expires: null,
          status: "active"
        });
      }

      const userData = await getUserData(userCredential.user.uid);

      // Save full user locally
      localStorage.setItem('user', JSON.stringify(userData));

      messageDiv.innerHTML = `<div class="success-msg">Success! Redirecting...</div>`;
      setTimeout(() => window.location.href = '/index.html', 1000);
    } catch(err) {
      console.error(err);
      messageDiv.innerHTML = `<div class="error-msg">${err.message}</div>`;
    }
  });

  // Auto redirect if already logged in
  (async () => {
    const existingUser = JSON.parse(localStorage.getItem('user'));
    if(existingUser){
      const updatedUser = await getUserData(existingUser.uid).catch(()=>existingUser);
      localStorage.setItem('user', JSON.stringify(updatedUser));
      window.location.href = '/index.html';
    }
  })();
  </script>
</body>
</html>
